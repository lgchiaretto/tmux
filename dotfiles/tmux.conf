# vim: set ft=tmux:

##################
#                #
#   .tmux.conf   #
#    chiaretto   #
#                #
##################

######################## Good practice ##########################
#   bind --> bind-key											#
#       -n flag: enable bind key without prefix					#
#   unbind --> unbind-key										#
#   set  --> set-option											#
#       -g flag: global											#
#   setw --> set-window-option									#
#   run  --> run-shell											#
#################################################################

######### Choose your own colours ##########
# for i in {0..255} ; do                   #
#    printf "\x1b[38;5;${i}mcolour${i}\n"; #
# done                                     #
############################################

######################## General Settings ########################
set -g mouse on # Enable mouse support
set -sg escape-time 0 # Reduce escape time for better responsiveness
set -g detach-on-destroy off # Prevent detaching when the last pane is closed
setw -g aggressive-resize on # Resize panes aggressively
setw -g automatic-rename on # Automatically rename windows based on the active process
set -g automatic-rename-format "#{?#{==:#{pane_current_command},bash},#{pane_current_path},#{pane_current_command}(#{pane_title})}" # Format for automatic renaming
set -g renumber-windows on # Renumber windows when one is closed
set -g history-limit 50000 # Increase scrollback buffer size
setw -g mode-keys vi # Use vi-style key bindings in copy mode
set -g status-keys vi # Use vi-style key bindings for status
set -g visual-activity off # Disable visual activity notifications
set -g visual-bell off # Disable visual bell
set -g visual-silence off # Disable visual silence notifications
set -g bell-action none # Disable bell action
set -g monitor-activity off # Disable activity monitoring
set -g default-terminal "tmux-256color" # Set default terminal to support 256 colors
set -ga terminal-overrides ",*256col*:Tc" # Enable true color support
set -ga terminal-overrides '*:Ss=\E[%p1%d q:Se=\E[ q' # Terminal override for cursor shape
set-environment -g COLORTERM "truecolor" # Set environment variable for true color
set -g word-separators " @#$%^&*()=+[]{}\\|;:\"<>,?'" # Define word separators for navigation

######################## Prefix Key ########################
unbind C-b # Unbind default prefix key
set -g prefix C-s # Set new prefix key to Ctrl+s
bind C-s send-prefix # Send prefix when Ctrl+s is pressed

######################## Session Management ########################
unbind N # Unbind default new-session key
bind N command-prompt "new-session -s '%%' -c '#{pane_current_path}'" # Create a new session with a custom name
unbind '.' # Unbind default rename-session key
bind . command-prompt "rename-session '%%'" # Rename the current session

######################## Window Management ########################
bind -n C-t new-window -c "#{pane_current_path}" # Create a new window in the current path
bind -n S-right next-window # Switch to the next window
bind -n S-left previous-window # Switch to the previous window
bind -n C-S-Left swap-window -t -1\; select-window -t -1 # Swap window left and select it
bind -n C-S-Right swap-window -t +1\; select-window -t +1 # Swap window right and select it
unbind ',' # Unbind default rename-window key
bind , command-prompt "rename-window '%%'" # Rename the current window

######################## Pane Management ########################
bind -n C-\\ split-window -h -c "#{pane_current_path}" # Split pane horizontally in the current path
bind \\ split-window -h -c "#{pane_current_path}" # Split pane horizontally
bind - split-window -v -c "#{pane_current_path}" # Split pane vertically
bind -n C-Left select-pane -L # Move to the pane on the left
bind -n C-Right select-pane -R # Move to the pane on the right
bind -n C-Up select-pane -U # Move to the pane above
bind -n C-Down select-pane -D # Move to the pane below
bind -n M-S-Left resize-pane -L # Resize pane to the left
bind -n M-S-Right resize-pane -R # Resize pane to the right
bind -n M-S-Up resize-pane -U # Resize pane upwards
bind -n M-S-Down resize-pane -D # Resize pane downwards
bind -n M-Up swap-pane -U # Swap pane upwards
bind -n M-Down swap-pane -D # Swap pane downwards
bind a setw synchronize-panes # Toggle synchronized panes

######################## Mouse and Clipboard ########################
unbind -n -T copy-mode-vi MouseDragEnd1Pane # Unbind default mouse drag end in copy mode
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-and-cancel; # Copy selection and exit copy mode
unbind MouseDown2Pane # Unbind default middle mouse button action
bind -n MouseDown2Pane run "tmux set-buffer \"$(xclip -o -sel clipboard)\"; tmux paste-buffer" # Paste from system clipboard
bind -T root C-v run -b "tmux paste-buffer" # Paste buffer with Ctrl+v

######################## Buffer Management ########################
set -g buffer-limit 1000 # Set buffer limit
bind B if 'test -n "$(tmux list-buffer)"' \
"choose-buffer -N -F \"#{buffer_sample}\" -O time" \
  "display-message 'Buffer is empty'" # Choose buffer or display message if empty

bind b display-popup  -w 50% -h 50% -E "sh -c '
tmux list-buffers -F \"#{buffer_name} #{buffer_sample}\" |
fzf --reverse --height=100%  --border=none |
awk \"{print \\$1}\" |
xargs -r -I {} tmux paste-buffer -b {}
'"
######################## Search and Navigation ########################
bind / copy-mode \; send-keys ? # Enter copy mode and search backward
bind -T copy-mode-vi C-f send -X page-down # Page down in copy mode
bind -T copy-mode-vi C-b send -X page-up # Page up in copy mode

######################## Reload Configuration ########################
bind R source-file ~/.tmux.conf \; display-message "tmux.conf reloaded." # Reload tmux configuration

######################## Open Configuration in Editor ########################
unbind e # Unbind default edit key
bind e new-window "vim ~/.tmux.conf" # Open tmux configuration in Vim

######################## Kill Commands ########################
bind k confirm kill-window # Confirm before killing the current window
bind K confirm-before -p 'Kill session (y/N)?' 'run-shell "tmux kill-session -t \"#S\"; tmux refresh-client -S;"' # Confirm before killing the current session
bind D confirm-before -p 'Confirm kill all sessions? (y/N)?' 'run-shell "tmux kill-server;"' # Confirm before killing all sessions

######################## Status Bar ########################
set -g status-style fg=colour221,bg=black # Darker background
set -g window-status-style fg=colour244,bg=black # Darker background
set -g window-status-activity-style fg=colour248,bg=black # Darker background
set -g window-status-current-style fg=colour221,bg=black # Darker background
set -g status-position bottom # Position status bar at the bottom
set -g status-left-length 120 # Set left status length
set -g status-right-length 60 # Set right status length
set -g status-right "#[fg=colour214][ #(/bin/bash $HOME/.tmux/vpn.tmux) #[fg=colour214]|#[fg=colour248]#{temp_cpu} #[fg=colour214]]" # Darker background
set -g status-left "#[fg=colour214][#[fg=color248]#S#[fg=color223]:#[fg=colour108]#(/bin/bash $HOME/.tmux/ocp-cluster.tmux)#[fg=colour214]] | " # Gruvbox theme
set -g window-status-current-format '#[fg=colour223,  nobold, noitalics, nounderscore]#W #[fg=green]#{?window_end_flag,#[range=user|new][+]#[norange],}#[norange]#[fg=colour214,  nobold, noitalics, nounderscore]#[fg=colour214] |'
set -g window-status-format '#[fg=colour244,  nobold, noitalics, nounderscore]#W #[fg=green]#{?window_end_flag,#[range=user|new][+]#[norange],}#[norange#[fg=colour214,  nobold, noitalics, nounderscore]#[fg=colour214] |'


######################## Pane Colors ########################
setw -g pane-active-border-style fg=colour214,bg=black # Darker background
setw -g pane-border-style fg=colour239,bg=black # Darker background
setw -g window-active-style 'bg=black' # Darker background
setw -g window-style 'bg=black' # Darker background
set -g message-style fg=colour221,bg=black # Darker background
set -g message-command-style fg=colour221,bg=black # Darker background
set -g display-panes-colour colour214 # Black background
setw -g clock-mode-colour colour214 # Black background
set -wg mode-style fg=colour221,bg=black # Darker background

######################## Mouse Interaction ########################
bind -Troot MouseDown1Status if -F '#{==:#{mouse_status_range},window}' {
    select-window
} {
    if -F '#{==:#{mouse_status_range},new}' {
        new-window -c "#{pane_current_path}"
    }
} # Handle mouse clicks on status bar

######################## Plugins ########################
set -g @plugin 'tmux-plugins/tmux-battery' # Plugin for battery status
set -g @plugin 'nhdaly/tmux-better-mouse-mode' # Plugin for better mouse support
set -g @plugin 'kolach/tmux-temp' # Plugin for temperature display
set -g @emulate-scroll-for-no-mouse-alternate-buffer "on" # Enable scroll emulation
set -g @scroll-in-moused-over-pane "off" # Disable scroll in mouse-over pane (used on copy from pane)
run '~/.tmux/plugins/tpm/tpm' # Run tmux plugin manager
run '~/.tmux/plugins/tmux-battery/battery.tmux' # Run battery plugin

######################## Utilities ########################
# URL Launcher
bind u run-shell -b "~/.tmux/fzf-url.sh open" # Open URL using fzf
bind y run-shell -b "~/.tmux/fzf-url.sh copy" # Copy URL using fzf

# Select OCP resources
unbind n
unbind l
unbind c
unbind V
unbind L
bind c run-shell -b "~/.tmux/fzf-context.sh" # Select a k8s context in a connected clusters
bind l run-shell -b "~/.tmux/fzf-podslogs.sh" # Logs for all selected pods using fzf
bind L run-shell -b "~/.tmux/fzf-allpodslogs.sh" # Logs for all selected pods using fzf
bind n run-shell -b "~/.tmux/fzf-nodes.sh" # Select a node name using fzf
bind o run-shell -b "~/.tmux/fzf-operators.sh" # Select OCP cluster operator using fzf
bind -n C-o run-shell -b "~/.tmux/fzf-ocp-apiresources.sh" # Select OCP api-resource
bind p run-shell -b "~/.tmux/fzf-pods.sh" # Select OCP pods using fxf
bind P run-shell -b "~/.tmux/fzf-projects.sh" # Select OCP project using fzf
bind r run-shell -b "~/.tmux/fzf-routes.sh" # Search and open route using fzf
bind v run-shell -b "~/.tmux/fzf-variablefiles.sh" # Search and open Ansible variable files using fzf
bind V run-shell -b "~/.tmux/fzf-vmwareusage.sh" # Search and open Ansible variable files using fzf

# Open a file or dir using tmux
unbind C-x
bind -n C-x run-shell -b "~/.tmux/fzf-files.sh" # Opens a file using vim

# Bind Ctrl+Shift+Y to copy the entire window buffer to the system clipboard
bind -n C-S-y run-shell -b "tmux capture-pane -p -S - | xclip -selection clipboard && tmux display-message 'Window buffer copied to clipboard.'"
