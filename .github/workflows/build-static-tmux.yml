name: Build Static tmux

on:
  push:
    branches: [ "master" ]
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tmux_version: ${{ steps.version.outputs.tmux_version }}
    steps:
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            echo "tmux_version=${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "tmux_version=3.6" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make wget tar gzip xz-utils bison

      - name: Build static tmux
        run: |
          cd build-static-tmux
          chmod +x build-static-tmux.sh
          TMUX_VERSION="${{ needs.setup.outputs.tmux_version }}" \
          USE_UPX="0" \
          DUMP_LOG_ON_ERROR=1 \
          ./build-static-tmux.sh
      
      - name: Decompress binary
        run: |
          cd /tmp/tmux-static/bin
          gunzip -f *.gz
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tmux-binary
          path: /tmp/tmux-static/bin/tmux*
          retention-days: 5

  release:
    needs: [setup, build]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: tmux-binary
          path: assets
      - name: Force Delete Old Release and Tag
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: v${{ needs.setup.outputs.tmux_version }}
        run: |
          echo "Target Tag: $TAG_NAME"
          
          gh release delete "$TAG_NAME" --cleanup-tag --yes || echo "Release not found (ok)"

          git push --delete origin "$TAG_NAME" || echo "Git tag not found (ok)"
          
          echo "Waiting 10s for API consistency..."
          sleep 10

      - name: Create Release / Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.setup.outputs.tmux_version }}
          name: tmux v${{ needs.setup.outputs.tmux_version }}
          draft: false
          prerelease: false
          files: assets/*
          # For√ßa o overwrite caso algo tenha sobrado
          fail_on_unmatched_files: true 
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}