name: Build Static tmux

on:
  push:
    branches: [ "master" ]
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tmux_version: ${{ steps.version.outputs.tmux_version }}
    steps:
      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            echo "tmux_version=${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "tmux_version=3.6" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make wget tar gzip xz-utils bison

      - name: Build static tmux
        run: |
          cd build-static-tmux
          chmod +x build-static-tmux.sh
          TMUX_VERSION="${{ needs.setup.outputs.tmux_version }}" \
          USE_UPX="0" \
          DUMP_LOG_ON_ERROR=1 \
          ./build-static-tmux.sh
      
      - name: Decompress binary
        run: |
          cd /tmp/tmux-static/bin
          gunzip -f *.gz
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tmux-binary
          path: /tmp/tmux-static/bin/tmux*
          retention-days: 5

  release:
    needs: [setup, build]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: tmux-binary
          path: assets

      - name: Delete Existing Release and All Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: v${{ needs.setup.outputs.tmux_version }}
        run: |
          echo "Target Tag: $TAG_NAME"
          
          RELEASE_ID=$(gh api repos/${{ github.repository }}/releases/tags/$TAG_NAME --jq '.id' 2>/dev/null || echo "")
          
          if [ -n "$RELEASE_ID" ]; then
            echo "Found release ID: $RELEASE_ID"
            
            echo "Deleting all release assets..."
            gh api repos/${{ github.repository }}/releases/$RELEASE_ID/assets --jq '.[].id' | while read ASSET_ID; do
              echo "Deleting asset ID: $ASSET_ID"
              gh api -X DELETE repos/${{ github.repository }}/releases/assets/$ASSET_ID
            done
            
            echo "Deleting release..."
            gh api -X DELETE repos/${{ github.repository }}/releases/$RELEASE_ID
          else
            echo "No existing release found for $TAG_NAME"
          fi
          
          echo "Deleting git tag if exists..."
          git push --delete origin "$TAG_NAME" 2>/dev/null || echo "Git tag not found (ok)"
          
          echo "Waiting 15s for API consistency..."
          sleep 15

      - name: Create Release / Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.setup.outputs.tmux_version }}
          name: tmux v${{ needs.setup.outputs.tmux_version }}
          draft: false
          prerelease: false
          generate_release_notes: false
          files: assets/*
          fail_on_unmatched_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-history:
    runs-on: ubuntu-latest
    needs: [release]
    if: always()
    steps:
      - name: Delete older workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 4