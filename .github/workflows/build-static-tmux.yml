name: Build Static tmux

on:
  push:
    branches: [ "master" ]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tmux_version:
        description: 'tmux version to build'
        required: false
        default: '3.6'
      use_upx:
        description: 'Compress with UPX'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      tmux_version: ${{ steps.version.outputs.tmux_version }}
      use_upx: ${{ steps.version.outputs.use_upx }}
    steps:
      - name: Determine Version and Flags
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            VERSION="${VERSION#v}"
            echo "tmux_version=${VERSION}" >> $GITHUB_OUTPUT
          else
            echo "tmux_version=${{ github.event.inputs.tmux_version || '3.6' }}" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ github.event.inputs.use_upx }}" = "true" ]; then
            echo "use_upx=1" >> $GITHUB_OUTPUT
          else
            echo "use_upx=0" >> $GITHUB_OUTPUT
          fi

  build:
    needs: setup
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make wget tar gzip xz-utils bison

      - name: Build static tmux
        run: |
          cd build-static-tmux
          chmod +x build-static-tmux.sh
          TMUX_VERSION="${{ needs.setup.outputs.tmux_version }}" \
          USE_UPX="${{ needs.setup.outputs.use_upx }}" \
          DUMP_LOG_ON_ERROR=1 \
          ./build-static-tmux.sh
      
      - name: Decompress binary
        run: |
          cd /tmp/tmux-static/bin
          gunzip -f *.gz
          ls -la

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tmux-binary
          path: /tmp/tmux-static/bin/tmux*
          retention-days: 5

  release:
    needs: [setup, build]
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write # Necessário para deletar e criar releases

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: tmux-binary
          path: assets

      - name: Delete existing release (if manual dispatch)
        if: github.event_name == 'workflow_dispatch'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: v${{ needs.setup.outputs.tmux_version }}
        run: |
          echo "Checking for existing release: $TAG_NAME"
          # Tenta deletar a release e a tag. O '|| true' impede que o workflow falhe se a release não existir.
          gh release delete "$TAG_NAME" --cleanup-tag --yes || true
          echo "Cleanup complete or release did not exist."

      - name: Create Release / Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'release' && github.event.release.tag_name || format('v{0}', needs.setup.outputs.tmux_version) }}
          name: tmux v${{ needs.setup.outputs.tmux_version }}
          draft: false
          prerelease: false
          files: assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}