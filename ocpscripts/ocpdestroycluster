#!/usr/bin/env bash

# Load configuration (global first, then user override)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$HOME/.tmux/config.sh" ]; then
    source "$HOME/.tmux/config.sh"
fi

cluster_name="$1"
# -----------------------------------------------------

# Exit if not running on bastion.chiaret.to
if [ "${CHECK_BASTION_HOST:-false}" = "true" ]; then
    if [ "$(hostname)" != "${BASTION_HOSTNAME:-bastion.chiaret.to}" ]; then
        echo "This script must be run on ${BASTION_HOSTNAME:-bastion.chiaret.to}. Exiting."
        exit 0
    fi
fi

config_base_path="$CLUSTERS_BASE_PATH/$cluster_name/$cluster_name"
config_file=""

if [[ -f "${config_base_path}.json" ]]; then
    config_file="${config_base_path}.json"
elif [[ -f "${config_base_path}.yaml" ]]; then
    config_file="${config_base_path}.yaml"
fi
# -----------------------------------------------------

infra=$(yq -r '.infra' "$config_file" || true)

if [[ "$infra" == "vsphere" ]]; then
    tmux send-keys "/home/lchiaret/git/openshift4-automation/run-playbooks-destroy.py $cluster_name & 2>&1" C-m
elif [[ "$infra" == "kvm" ]]; then
    # Create new tmux session for KVM cluster destruction
    session_name="destroy-kvm-${cluster_name}"
    tmux has-session -t "$session_name" 2>/dev/null && tmux kill-session -t "$session_name"; tmux new-session -d -s "$session_name"; tmux switch-client -t "$session_name"; tmux send-keys -t "$session_name" "ansible-playbook -e@$config_file $ANSIBLE_PLAYBOOK_KVM_PATH/destroy-cluster.yml" C-m
fi