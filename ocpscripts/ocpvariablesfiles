#!/usr/bin/env bash

# Load configuration (global first, then user override)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "/etc/tmux-ocp/config.sh" ]; then
    source "/etc/tmux-ocp/config.sh"
fi
if [ -f "$HOME/.tmux/config.sh" ]; then
    source "$HOME/.tmux/config.sh"
fi
if [ -f "$HOME/git/tmux/config.sh" ]; then
    source "$HOME/git/tmux/config.sh"
fi
# Set defaults if not configured
CLUSTERS_BASE_PATH="${CLUSTERS_BASE_PATH:-/vms/clusters}"
CLUSTER_VARIABLES_DIR="${CLUSTER_VARIABLES_DIR:-${CLUSTERS_BASE_PATH}/variables-files}"
KVM_VARIABLES_DIR="${KVM_VARIABLES_DIR:-${CLUSTERS_BASE_PATH}/variables-files-kvm}"

# First, select the infrastructure type
infra_type=$(echo -e "vSphere\nKVM" | fzf-tmux \
    --header=$'
------------------------------------ Select Infrastructure Type ------------------------------------------
|                                                                                                            |
|  [Enter]....Select infrastructure type                                                                    |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n' \
    --layout=reverse \
    --border-label=" $FZF_BORDER_LABEL " \
    --border-label-pos=center \
    -h 15 -p "55%,46%" \
    --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
    --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665 \
    )

if [ -z "$infra_type" ]; then
    tmux display -d 3000 "No infrastructure type selected"
    exit 0
fi

# Based on infrastructure type, list available variable files
if [ "$infra_type" = "vSphere" ]; then
    # Check if directory exists
    if [ ! -d "$CLUSTER_VARIABLES_DIR" ]; then
        tmux display -d 3000 "Error: vSphere variables directory not found: $CLUSTER_VARIABLES_DIR"
        exit 1
    fi
    
    # Find all JSON files in the vSphere variables directory
    files=$(find "$CLUSTER_VARIABLES_DIR" -maxdepth 1 -type f -name "*.json" -exec basename {} \; | sort)
    
    if [ -z "$files" ]; then
        tmux display -d 3000 "No vSphere variable files found in $CLUSTER_VARIABLES_DIR"
        exit 0
    fi
    
    selected_file=$(echo "$files" | fzf-tmux \
        --header=$'
------------------------------------ vSphere Variable Files ----------------------------------------------
|                                                                                                            |
|  [Enter]....Edit the selected variable file                                                                |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n' \
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,46%" \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665 \
        )
    
    if [ -n "$selected_file" ]; then
        file="$CLUSTER_VARIABLES_DIR/$selected_file"
        if [ -f "$file" ]; then
            tmux new-window -n "vim $(basename $file)" "vim $file; tmux wait-for -S vim-done"
            tmux wait-for vim-done
        else
            tmux display -d 3000 "Error: File not found: $file"
        fi
    fi

elif [ "$infra_type" = "KVM" ]; then
    # Check if directory exists
    if [ ! -d "$KVM_VARIABLES_DIR" ]; then
        tmux display -d 3000 "Error: KVM variables directory not found: $KVM_VARIABLES_DIR"
        exit 1
    fi
    
    # Find all YAML files in the KVM variables directory
    files=$(find "$KVM_VARIABLES_DIR" -maxdepth 1 -type f \( -name "*.yaml" -o -name "*.yml" \) -exec basename {} \; | sort)
    
    if [ -z "$files" ]; then
        tmux display -d 3000 "No KVM variable files found in $KVM_VARIABLES_DIR"
        exit 0
    fi
    
    selected_file=$(echo "$files" | fzf-tmux \
        --header=$'
┌──────────────────────────────────────────────── Help ──────────────────────────────────────────────────┐
│                                                                                                        │
│  [Enter]....Edit the selected variable file                                                            │
│  [Esc]......Exit                                                                                       │
│                                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────────────────────┘\n\n' \
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,46%" \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665 \
        )
    
    if [ -n "$selected_file" ]; then
        file="$KVM_VARIABLES_DIR/$selected_file"
        if [ -f "$file" ]; then
            tmux new-window -n "vim $(basename $file)" "vim $file; tmux wait-for -S vim-done"
            tmux wait-for vim-done
        else
            tmux display -d 3000 "Error: File not found: $file"
        fi
    fi
fi

if [ -z "$selected_file" ]; then
    tmux display -d 3000 "No file selected"
    exit 0
fi