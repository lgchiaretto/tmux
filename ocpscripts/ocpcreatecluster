#!/usr/bin/env bash

# Load configuration (global first, then user override)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$HOME/.tmux/config.sh" ]; then
    source "$HOME/.tmux/config.sh"
fi

# Exit if not running on bastion.chiaret.to
if [ "${CHECK_BASTION_HOST:-false}" = "true" ]; then
    if [ "$(hostname)" != "${BASTION_HOSTNAME:-bastion.chiaret.to}" ]; then
        echo "This script must be run on ${BASTION_HOSTNAME:-bastion.chiaret.to}. Exiting."
        exit 0
    fi
fi

#files=$(find $CLUSTER_VARIABLES_DIR/ -type f -exec basename {} \; | sed 's/^ansible-vars-//' | sed 's/\.json$//')

function createVphereCluster() {
    actions="- Baremetal IPI 3-node cluster
- Baremetal IPI 4-node cluster
- Baremetal IPI 5-node cluster
- Baremetal UPI Single node OpenShift
- Baremetal UPI Single node OpenShift with worker nodes
- Baremetal UPI Single node OpenShift with ODF nodes
- Baremetal UPI Single node OpenShift with Virt nodes
- Baremetal UPI Single node OpenShift with Virt nodes - Migration demo
- None UPI 3-node cluster
- None UPI 3-node cluster with 'ODF'
- vSphere IPI 3-node cluster
- vSphere UPI 3-node cluster
- vSphere UPI 3-node cluster with RHBK
- Assisted Installer"

    selected_file=$(echo -e "$actions" | sort | fzf-tmux \
        --header=$'
----------------------------------------- Create cluster -----------------------------------------------------
|                                                                                                            |
|  [Enter]....Create the cluster                                                                             |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n' \
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,46%" \
        --no-input \
        --no-sort \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665
        )

    variablesfile=$(echo "$selected_file" | tail -n1)

    if [ -n "$selected_file" ]; then
        case "$variablesfile" in
            "- Baremetal IPI 3-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-ipi-3node-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal IPI 4-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-ipi-4node-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal IPI 5-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-ipi-5node-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal UPI Single node OpenShift")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-sno-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal UPI Single node OpenShift with worker nodes")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-sno-worker-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal UPI Single node OpenShift with ODF nodes")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-sno-odf-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal UPI Single node OpenShift with Virt nodes")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-sno-virt-baremetal.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Baremetal UPI Single node OpenShift with Virt nodes - Migration demo")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-sno-virt-baremetal-demo.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- vSphere IPI 3-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-ipi-3node-vsphere.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- None UPI 3-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-3node-none.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- None UPI 3-node cluster with 'ODF'")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-3node-odf-none.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- None UPI Single node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-sno-none.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- None UPI Single node cluster with 'OCP Virt'")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-sno-ocpvirt-none.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- None UPI Single node cluster with 'ODF'")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-sno-odf-none.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- vSphere UPI 3-node cluster")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-3node-vsphere.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- vSphere UPI 3-node cluster with RHBK")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-upi-3node-vsphere-rhbk.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                ;;
            "- Assisted Installer")
                file="$CLUSTER_VARIABLES_DIR/ansible-vars-assisted-installer.json"
                tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
                tmux wait-for vim-done
                assistedinstaller="true"
                ;;
        esac
    fi

    if [ -n "$selected_file" ]; then
        if [[ "$customname" == "Yes" ]]; then
          clear
          read -p "Do you want to create the cluster \"$cluster_name_custom\"? (y/N): " confirm
          if [[ "$confirm" == "n" || "$confirm" == "N" || $confirm == "" ]]; then
              echo "Aborted."
              exit 0
          fi
          jq '.deleteiffailed = "true"' $file > $file.tmp && mv $file.tmp $file
          jq '.createcertfiles = "true"' $file > $file.tmp && mv $file.tmp $file
          if [[ "$assistedinstaller" == "true" ]]; then
              tmux send-keys "$OPENSHIFT4_AUTOMATION_PATH/createcluster.py -i $file -n $cluster_name_custom -a" C-m
          else
              tmux send-keys "$OPENSHIFT4_AUTOMATION_PATH/createcluster.py -i $file -n $cluster_name_custom" C-m
          fi
        else
          jq '.deleteiffailed = "false"' $file > $file.tmp && mv $file.tmp $file
          jq '.createcertfiles = "false"' $file > $file.tmp && mv $file.tmp $file
          if [[ "$assistedinstaller" == "true" ]]; then
            tmux send-keys "$OPENSHIFT4_AUTOMATION_PATH/createcluster.py -i $file -a true" C-m
          else
            tmux send-keys "$OPENSHIFT4_AUTOMATION_PATH/createcluster.py -i $file" C-m
          fi
        fi
    else
    #    tmux display -d 3000 "No file selected"
        exit 0
    fi
}

function createKVMCluster(){
    if [ ! -d "$KVM_VARIABLES_DIR" ]; then
        echo "Error: KVM variables directory not found: $KVM_VARIABLES_DIR"
        echo "Please create the directory and add your cluster variable files."
        exit 1
    fi

    files=$(find "$KVM_VARIABLES_DIR" -type f -name "*.yaml" -exec basename {} \; 2>/dev/null)
    
    if [ -z "$files" ]; then
        echo "Error: No cluster variable files found in $KVM_VARIABLES_DIR"
        echo "Please add JSON variable files for your KVM clusters."
        exit 1
    fi

    selected_file=$(echo "$files" | fzf-tmux \
        --header=$'
┌────────────────────────────────────── Create KVM cluster ──────────────────────────────────────────────┐
│                                                                                                        │
│  [Enter]....Select cluster variable file                                                               │
│  [Esc]......Exit                                                                                       │
│                                                                                                        │
└────────────────────────────────────────────────────────────────────────────────────────────────────────┘\n\n' \
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,46%" \
        --no-sort \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665
        )

    if [ -z "$selected_file" ]; then
        exit 0
    fi

    file="$KVM_VARIABLES_DIR/$selected_file"
    
    tmux new-window -n "vim $file" "vim $file; tmux wait-for -S vim-done"
    tmux wait-for vim-done
    
    clustername=$(yq -r '.clustername' "$file")
    
    if [ -z "$clustername" ]; then
        echo "Error: Could not find cluster name in $file"
        echo "Make sure the JSON file has a 'clustername' field."
        exit 1
    fi

    # Create new tmux session for KVM cluster creation
    session_name="create-kvm-${clustername}"
    tmux has-session -t "$session_name" 2>/dev/null && tmux kill-session -t "$session_name"; tmux new-session -d -s "$session_name"; tmux switch-client -t "$session_name"; tmux send-keys -t "$session_name" "ansible-playbook -i localhost -e \"clustername=$clustername\" -e \"@$file\" $ANSIBLE_PLAYBOOK_KVM_PATH/create-cluster-upi-kvm-modular.yaml" C-m
}

# begin
infra="vSphere\nKVM"

selected_infra=$(echo -e "$infra" | fzf-tmux \
    --header=$'
----------------------------------------- Create cluster -----------------------------------------------------
|                                                                                                            |
|  [Enter]....Select the infra                                                                               |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n' \
    --layout=reverse \
    --border-label=" $FZF_BORDER_LABEL " \
    --border-label-pos=center \
    -h 40 -p "55%,46%" \
    --no-input \
    --no-sort \
    --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
    --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665
    )

if [ -z "$selected_infra" ]; then
    exit 0
fi

# For KVM, skip custom name and certificate prompts
if [ "$selected_infra" == "KVM" ]; then
    createKVMCluster
    exit 0
fi

# For vSphere, continue with custom name and certificate logic
# Only show custom name option on bastion.chiaret.to (chiarettolabs)
if [ "$(hostname)" == "${BASTION_HOSTNAME:-bastion.chiarettolabs.com.br}" ]; then
    customname=$(echo -e "Yes\nNo" | fzf-tmux \
        --header=$'
----------------------------------------- Cluster Name -------------------------------------------------------
|                                                                                                            |
|  [Enter]....Create Cluster with custom name (must exist certificates)                                      |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n' \
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,46%" \
        --no-input \
        --no-sort \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665
        )

    if [ -z "$customname" ]; then
        exit 0
    fi

    cluster_name_custom=$(/usr/local/bin/listcerts | fzf-tmux \
        --header=$'
----------------------------------------- Create Certs -------------------------------------------------------
|                                                                                                            |
|  [Enter]....Select the available cluster name custom                                                       |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------
cluster name       | VLAN    | SSL Expire
--------------------------------------------------------------------------------------------------------------'\
        --layout=reverse \
        --border-label=" $FZF_BORDER_LABEL " \
        --border-label-pos=center \
        -h 40 -p "55%,93%" \
        --no-input \
        --no-sort \
        --color=fg:#ffffff,bg:#1d2021,hl:#d8a657 \
        --color=fg+:#a9b665,bg+:#1d2021,hl+:#a9b665 | awk '{print $1}'
    )

    if [ -z "$cluster_name_custom" ]; then
        exit 0
    fi
else
    # On non-bastion servers, use automatic cluster naming (no certificates)
    customname="No"
fi

# Execute vSphere cluster creation
if [ -n "$selected_infra" ]; then
    case "$selected_infra" in
        "vSphere")
            createVphereCluster
            exit 0
            ;;
    esac
else
    exit 0
fi


