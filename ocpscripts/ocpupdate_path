#!/bin/bash

GRAPH_URL="https://api.openshift.com/api/upgrades_info/graph"
CHANNELS=(
    "eus-4.14"
    "stable-4.15"
    "eus-4.16"
    "stable-4.17"
    "eus-4.18"
)

HEADER="
----------------------------------------- Update path tool ---------------------------------------------------
|                                                                                                            |
|  [Enter]....Select the channel                                                                             |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n
"

fzf_select() {
    local options="$1"
    local header_text="$2"
    local search_args="$3"

    full_header="${HEADER/Select the channel/$header_text}"

    local options_file=$(mktemp)
    result=$(echo -e "$options" | sort -V | fzf-tmux --header "$full_header" --layout=reverse -h "40%" -p "55%,46%" --exact)
    echo "$result"
}

fetch_upgrade_graph() {
    local channel="$1"
    local url="${GRAPH_URL}?channel=${channel}&arch=amd64"

    response=$(curl -s "$url")
    if [ $? -ne 0 ]; then
        echo "Error fetching graph." >&2
        exit 2
    fi

    echo "$response"
}

get_versions() {
    local data="$1"
    echo "$data" | jq -r '.nodes[].version'
}

channel=$(fzf_select "$(printf "%s\n" "${CHANNELS[@]}")" "Select OCP Channel" "--no-input")
if [ -z "$channel" ]; then
    exit 0
fi

data=$(fetch_upgrade_graph "$channel")
versions=$(get_versions "$data")

from_version=$(fzf_select "$versions" "Select from Version" "--exact")
if [ -z "$from_version" ]; then
    exit 0
fi

script_dir="/usr/local/bin/ocpupdate_lib.py"
    
echo -e "$versions" | sort -V | fzf-tmux \
    --header $"Select 'to' Version\n" \
    --layout=reverse \
    -h "40%" \
    -p "55%,46%" \
    --exact \
    --preview "python3 ${script_dir} --from-version ${from_version} --channel ${channel} --to-version {}" \
    --bind "enter:ignore" \
    --preview-window "right:80%" \
    --delimiter "---"
    
exit 0
