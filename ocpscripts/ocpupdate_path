#!/bin/bash

GRAPH_URL="https://api.openshift.com/api/upgrades_info/graph"
CHANNELS=(
    "eus-4.14"
    "stable-4.15"
    "eus-4.16"
    "stable-4.17"
    "eus-4.18"
)

HEADER="
----------------------------------------- Update path tool ---------------------------------------------------
|                                                                                                            |
|  [Enter]....Select the channel                                                                             |
|  [Esc]......Exit                                                                                           |
|                                                                                                            |
--------------------------------------------------------------------------------------------------------------\n\n
"

fzf_select() {
    local options="$1"
    local header_text="$2"
    local search_args="$3"

    full_header="${HEADER/Select the channel/$header_text}"

    local options_file=$(mktemp)
    result=$(echo -e "$options" | sort -V | fzf-tmux \
        --header "$full_header" \
        --layout=reverse \
        --border-label=" chiaret.to " \
        --border-label-pos=center \
        -h "40%" -p "55%,46%" \
        --exact)
    echo "$result"
}

fetch_upgrade_graph() {
    local channel="$1"
    local url="${GRAPH_URL}?channel=${channel}&arch=amd64"

    response=$(curl -s "$url")
    if [ $? -ne 0 ]; then
        echo "Error fetching graph." >&2
        exit 2
    fi

    echo "$response"
}

get_versions() {
    local data="$1"
    echo "$data" | jq -r '.nodes[].version'
}

versions=`/usr/local/bin/ocpgetreleases.py`

from_version=$(fzf_select "$versions" "Select from Version" "--exact")
if [ -z "$from_version" ]; then
    exit 0
fi

script_dir="/usr/local/bin/ocpgenerate-graph.py"
    
echo -e "$versions" | sort -rV |fzf-tmux \
     --header=$'------------------------

[r]     Release notes
[Esc]   Exit
------------------------
Select to version\n\n' \
    --layout=reverse \
    --border-label=" chiaret.to " \
    --border-label-pos=center \
    -h "40%" \
    -p "55%,46%" \
    --exact \
    --preview "python3 ${script_dir} --from-version ${from_version} --to-version {}" \
    --bind "enter:ignore" \
    --bind "r:execute-silent(/usr/local/bin/ocpreleasenotes {})" \
    --preview-window "right:76%"
    
exit 0
